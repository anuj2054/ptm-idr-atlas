<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PTM-IDR Atlas</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; color: #222; }
    header { margin-bottom: 20px; }
    h1 { margin: 0 0 6px; font-size: 22px; }
    .meta { color: #555; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom: 1px solid #eee; padding: 8px 6px; text-align: left; }
    th { background: #fafafa; font-weight: 600; font-size: 14px; }
    .muted { color: #666; font-size: 12px; }
    .pill { display: inline-block; padding: 2px 6px; border-radius: 10px; background: #eef; color: #225; font-size: 12px; }
    a { color: #0b5fff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    footer { margin-top: 24px; font-size: 12px; color: #666; }
    .error { color: #b00020; }
    .grid { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
  </style>
  <noscript>
    <style> #app { display:none } </style>
  </noscript>
  <meta name="robots" content="noindex">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  <meta http-equiv="pragma" content="no-cache">
  <link rel="icon" href="data:,">
  <!-- Minimal static browser for index.json -->
  <!-- If JavaScript is disabled, you can open index.json directly. -->
</head>
<body>
  <header class="grid">
    <div>
      <h1>PTM-IDR Atlas</h1>
      <div class="meta" id="meta">Loading metadata…</div>
    </div>
    <div>
      <a href="index.json" class="pill" title="View raw JSON index">index.json</a>
    </div>
  </header>

  <div id="app">
    <table id="artifacts-table" aria-label="Artifacts">
      <thead>
        <tr>
          <th>Filename</th>
          <th>Description</th>
          <th>Format</th>
          <th>Size</th>
          <th>Download</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div id="empty" class="muted" style="display:none">No artifacts found.</div>
  </div>

  <hr style="margin:24px 0; border:none; border-top:1px solid #eee">

  <section>
    <h2 style="margin:0 0 8px; font-size:18px">Protein Browser</h2>
    <div class="muted">Enter a UniProt accession to load significant hotspot windows.</div>
    <div style="margin:10px 0; display:flex; gap:8px">
      <input id="acc-input" type="text" placeholder="e.g., O14920" style="padding:6px 8px; font-size:14px; width:220px">
      <button id="acc-load" style="padding:6px 10px; font-size:14px">Load</button>
    </div>
    <div id="protein-status" class="muted"></div>
    <div id="protein-view"></div>
    <canvas id="protein-canvas" width="900" height="120" style="width:100%; max-width:900px; height:120px; border:1px solid #eee; margin-top:10px"></canvas>
    <div class="muted" style="margin-top:4px">Legend: <span style="display:inline-block;width:10px;height:10px;background:#2e7d32;margin:0 4px 0 8px"></span>IDR window <span style="display:inline-block;width:10px;height:10px;background:#6e6e6e;margin:0 4px 0 12px"></span>Ordered window</div>
  </section>

  <section style="margin-top:24px">
    <h2 style="margin:0 0 8px; font-size:18px">Featured Examples</h2>
    <div class="muted">Curated proteins from the manuscript case studies and figures.</div>
    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:10px">
      <button class="pill" data-acc="P00533" title="EGFR — epidermal growth factor receptor">EGFR (P00533)</button>
      <button class="pill" data-acc="O75530" title="EED — ultra-regulation case">EED (O75530)</button>
      <button class="pill" data-acc="P37840" title="SNCA — alpha-synuclein">SNCA (P37840)</button>
    </div>
  </section>

  <div id="err" class="error" role="alert" style="display:none"></div>

  <footer>
    <span class="muted">Served from GitHub Pages. Uses site/index.json generated by the atlas tools.</span>
  </footer>

  <script>
    (function() {
      const meta = document.getElementById('meta');
      const tbody = document.getElementById('tbody');
      const empty = document.getElementById('empty');
      const err = document.getElementById('err');

      fetch('index.json', { cache: 'no-store' })
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        })
        .then(data => {
          meta.textContent = `${data.project} • v${data.version} • ${new Date(data.generated_at).toLocaleString()}`;

          const rows = (data.artifacts || []).map(a => {
            const tr = document.createElement('tr');

            const tdName = document.createElement('td');
            tdName.textContent = a.filename;
            tr.appendChild(tdName);

            const tdDesc = document.createElement('td');
            tdDesc.textContent = a.description || '';
            tr.appendChild(tdDesc);

            const tdFmt = document.createElement('td');
            tdFmt.textContent = (a.format || '').toUpperCase();
            tr.appendChild(tdFmt);

            const tdSize = document.createElement('td');
            const size = (typeof a.size_mb === 'number') ? `${a.size_mb.toFixed(2)} MB` : `${a.size_bytes} bytes`;
            tdSize.textContent = size;
            tr.appendChild(tdSize);

            const tdLink = document.createElement('td');
            const link = document.createElement('a');
            link.href = a.download_url;
            link.textContent = 'Download';
            link.rel = 'noopener';
            link.target = '_blank';
            tdLink.appendChild(link);
            tr.appendChild(tdLink);

            return tr;
          });

          if (rows.length === 0) {
            empty.style.display = 'block';
          } else {
            rows.forEach(tr => tbody.appendChild(tr));
          }
        })
        .catch(e => {
          meta.textContent = 'Failed to load index metadata';
          err.style.display = 'block';
          err.textContent = 'Error loading index.json: ' + e.message + '. You can open index.json directly using the link above.';
        });

      // Simple protein browser
      const input = document.getElementById('acc-input');
      const loadBtn = document.getElementById('acc-load');
      const pstat = document.getElementById('protein-status');
      const pview = document.getElementById('protein-view');

      function fmtWindows(wins) {
        if (!wins || wins.length === 0) return '<div class="muted">No significant windows found.</div>';
        const rows = wins.slice(0, 200).map(w => `
          <tr>
            <td>${w.start}-${w.end}</td>
            <td>${w.idr ? 'IDR' : 'ORD'}</td>
            <td>${w.ptm_count}</td>
            <td>${w.q != null ? w.q.toExponential(2) : ''}</td>
          </tr>
        `).join('');
        return `
          <table style="width:100%; border-collapse:collapse; margin-top:8px">
            <thead>
              <tr>
                <th style="text-align:left; border-bottom:1px solid #eee; padding:6px 4px">Window</th>
                <th style="text-align:left; border-bottom:1px solid #eee; padding:6px 4px">Region</th>
                <th style="text-align:left; border-bottom:1px solid #eee; padding:6px 4px">PTMs</th>
                <th style="text-align:left; border-bottom:1px solid #eee; padding:6px 4px">q</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        `;
      }

      function drawTrack(wins) {
        const canvas = document.getElementById('protein-canvas');
        const ctx = canvas.getContext('2d');
        const W = canvas.width, H = canvas.height;
        ctx.clearRect(0, 0, W, H);
        if (!wins || wins.length === 0) return;

        // Determine protein length proxy from max end
        const maxEnd = Math.max(...wins.map(w => w.end || 0), 1);
        const padL = 40, padR = 10, padT = 20, padB = 30;
        const trackY = padT + 20, trackH = 16;
        const innerW = Math.max(W - padL - padR, 10);
        const xScale = x => padL + (x / maxEnd) * innerW;

        // Axis
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(padL, trackY + trackH + 8);
        ctx.lineTo(W - padR, trackY + trackH + 8);
        ctx.stroke();
        ctx.fillStyle = '#666';
        ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
        // Ticks at 0%, 25%, 50%, 75%, 100%
        [0, 0.25, 0.5, 0.75, 1].forEach(f => {
          const x = xScale(maxEnd * f);
          ctx.fillRect(x, trackY + trackH + 8, 1, 4);
          const label = Math.round(maxEnd * f);
          ctx.fillText(label, x - 6, trackY + trackH + 20);
        });

        // Track baseline
        ctx.fillStyle = '#f3f3f3';
        ctx.fillRect(padL, trackY, innerW, trackH);

        // Windows
        wins.forEach(w => {
          const x1 = xScale(Math.max(0, w.start - 1));
          const x2 = xScale(Math.max(w.start, w.end));
          const ww = Math.max(1, x2 - x1);
          ctx.fillStyle = w.idr ? '#2e7d32' : '#6e6e6e';
          ctx.fillRect(x1, trackY, ww, trackH);
        });

        // Title
        ctx.fillStyle = '#222';
        ctx.font = '14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
        ctx.fillText('Significant hotspot windows', padL, padT);
      }

      function loadProtein(acc) {
        const clean = (acc || '').trim();
        if (!clean) return;
        pstat.textContent = 'Loading ' + clean + '…';
        pview.innerHTML = '';
        fetch('results/atlas/v1.0/proteins/' + encodeURIComponent(clean) + '.json', { cache: 'no-store' })
          .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
          .then(data => {
            pstat.textContent = `Loaded ${data.accession} • ${data.windows.length} windows`;
            pview.innerHTML = fmtWindows(data.windows);
            drawTrack(data.windows);
          })
          .catch(e => {
            pstat.textContent = '';
            pview.innerHTML = '<div class="error">Not found or no windows for ' + clean + '</div>';
            drawTrack([]);
          });
      }

      loadBtn.addEventListener('click', () => loadProtein(input.value));
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') loadProtein(input.value); });

      // Wire featured example buttons
      document.querySelectorAll('button.pill[data-acc]').forEach(btn => {
        btn.addEventListener('click', () => {
          const acc = btn.getAttribute('data-acc');
          input.value = acc;
          loadProtein(acc);
        });
      });

      // Preload a featured example on first load
      loadProtein('P00533');
    })();
  </script>
  <noscript>
    <p class="error">JavaScript is disabled. Open <a href="index.json">index.json</a> to view artifacts.</p>
  </noscript>
</body>
<\/html>
