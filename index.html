<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PTM-IDR Atlas</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #ffffff;
      --fg: #1f1f1f;
      --muted: #616161;
      --accent: #2255cc;
      --card-bg: #f8f9ff;
      --card-border: #dee3ff;
    }
    body {
      margin: 0;
      padding: 28px 20px 40px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.5;
    }
    main { max-width: 980px; margin: 0 auto; position: relative; }
    header { margin-bottom: 28px; }
    h1 { margin: 0 0 10px; font-size: 28px; font-weight: 650; }
    h2 { font-size: 20px; margin: 0 0 10px; font-weight: 600; }
    p { margin: 0 0 12px; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .muted { color: var(--muted); font-size: 13px; }
    .hero-meta { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .summary { display: grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap: 12px; margin: 18px 0 26px; }
    .summary div { padding: 12px 14px; border: 1px solid #eceff7; border-radius: 10px; background: #fafbff; }
    .summary strong { display: block; font-size: 12px; text-transform: uppercase; letter-spacing: 0.6px; color: var(--muted); margin-bottom: 4px; }
    .summary span { font-size: 16px; font-weight: 600; }
    .pill { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 999px; border: 1px solid var(--card-border); background: #eef1ff; color: #233375; font-size: 12px; cursor: pointer; }
    .pill:hover { background: #dfe5ff; }
    .info-card { padding: 18px; border-radius: 12px; border: 1px solid #ebeffa; background: var(--card-bg); margin: 16px 0 28px; }
    .card-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap: 14px; margin-top: 14px; }
    .card { padding: 16px; border-radius: 12px; border: 1px solid var(--card-border); background: var(--card-bg); display: flex; flex-direction: column; gap: 10px; }
    .card-title { font-size: 18px; font-weight: 600; }
    .card button { align-self: flex-start; }
    .preview-canvas { width: 100%; height: 68px; border: 1px solid #e4e4e4; border-radius: 4px; margin-top: 6px; }
    .panel { margin-top: 28px; }
    .protein-toolbar { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-start; margin-top: 12px; }
    .protein-info-card { padding: 12px 16px; border-radius: 10px; border: 1px solid #e0e5f7; background: #fafdff; min-width: 240px; font-size: 13px; color: #25304d; line-height: 1.4; }
    .protein-info-card strong { display: block; font-size: 15px; margin-bottom: 4px; }
    .protein-info-card a { color: #1f4de3; }
    .toggle-group { display: flex; flex-wrap: wrap; gap: 12px; padding: 6px 0; }
    .toggle-group label { display: inline-flex; align-items: center; gap: 6px; font-size: 13px; color: #374151; user-select: none; }
    .toggle-group input { accent-color: #204de5; }
    .input-row { display: flex; flex-wrap: wrap; gap: 10px; margin: 12px 0; }
    #motif-list li { margin-bottom: 6px; font-size: 13px; color: #2d3b63; }
    input[type="text"] { padding: 8px 10px; border: 1px solid #ccd2e6; border-radius: 6px; font-size: 15px; min-width: 220px; }
    button.load-btn { padding: 8px 14px; border-radius: 6px; border: 1px solid #ccd2e6; background: #ecf1ff; font-size: 15px; cursor: pointer; }
    button.load-btn:hover { background: #dfe7ff; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { padding: 6px 6px; text-align: left; border-bottom: 1px solid #eceff5; }
    th { font-weight: 600; color: var(--muted); }
    tbody tr.row-active { background: #eef3ff; }
    tbody tr:hover { background: #f5f7ff; }
    canvas { border: 1px solid #e4e4e4; border-radius: 4px; }
    footer { margin-top: 36px; font-size: 12px; color: var(--muted); }
    .error { color: #b00020; margin-top: 12px; }
    .tooltip { position: absolute; padding: 6px 8px; border-radius: 6px; background: rgba(33, 37, 41, 0.92); color: #fff; font-size: 12px; pointer-events: none; box-shadow: 0 2px 6px rgba(0,0,0,0.18); z-index: 1000; min-width: 140px; }
    @media (max-width: 640px) {
      body { padding: 24px 16px; }
      canvas { height: 120px; }
    }
  </style>
  <meta name="robots" content="noindex">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  <meta http-equiv="pragma" content="no-cache">
  <link rel="icon" href="data:,">
</head>
<body>
  <main>
    <header>
      <h1>PTM-IDR Atlas</h1>
      <div class="hero-meta">
        <div id="meta" class="muted">Loading metadata…</div>
        <a href="index.json" class="pill" title="Programmatic catalog">index.json</a>
      </div>
      <p>The atlas delivers statistically significant PTM hotspots within intrinsically disordered regions across the human proteome. Explore curated examples, inspect any UniProt accession, or integrate the data into downstream analyses.</p>
    </header>

    <div class="summary">
      <div><strong>Version</strong><span id="summary-version">—</span></div>
      <div><strong>Generated</strong><span id="summary-generated">—</span></div>
      <div><strong>Core Tables</strong><span id="summary-artifacts">—</span></div>
    </div>

    <section class="info-card">
      <h2>What’s inside</h2>
      <ul>
        <li>Hotspot windows annotated with IDR localization and significance testing.</li>
        <li>Per-protein summaries capturing hotspot counts and regulatory burden.</li>
        <li>Validation overlays (ELM motifs, IPTMNet, variant proximity) for downstream interpretation.</li>
      </ul>
      <div class="muted">For full artifact metadata see <code>site/index.json</code>.</div>
    </section>

    <section class="panel">
      <h2>Motif enrichment highlights</h2>
      <div class="muted">Top ELM motifs enriched inside PTM hotspots (global analysis).</div>
      <ul id="motif-list" class="muted" style="list-style:none; padding-left:0; margin-top:10px"></ul>
    </section>

    <section class="panel">
      <h2>Featured case studies</h2>
      <div class="muted">Quick links to proteins highlighted in the manuscript figures and therapeutic discussion.</div>
      <div class="card-grid" id="featured-grid"></div>
    </section>

    <section class="panel">
      <h2>Interactive protein browser</h2>
      <div class="muted">Inspect significant hotspot windows for any UniProt accession.</div>
      <div class="input-row">
        <input id="acc-input" type="text" placeholder="Enter UniProt accession (e.g., P00533)">
        <button id="acc-load" class="load-btn">Load protein</button>
      </div>
      <div id="protein-status" class="muted"></div>
      <div class="protein-toolbar">
        <div id="protein-info" class="protein-info-card">
          <strong>Select a protein</strong>
          <div>Hotspot summary and PTM markers will appear here.</div>
        </div>
        <div class="toggle-group">
          <label><input type="checkbox" id="toggle-idr-shading" checked> IDR shading</label>
          <label><input type="checkbox" id="toggle-idr-hotspots" checked> IDR hotspots</label>
          <label><input type="checkbox" id="toggle-ordered-hotspots" checked> Ordered hotspots</label>
          <label><input type="checkbox" id="toggle-ptms" checked> PTM markers</label>
          <label><input type="checkbox" id="toggle-variants" checked> Variant markers</label>
        </div>
      </div>
      <canvas id="protein-canvas" width="920" height="180" style="width:100%; height:180px; margin-top:14px"></canvas>
      <div class="muted" style="margin-top:6px">Legend:
        <span style="display:inline-block;width:16px;height:16px;background:rgba(46,125,50,0.18);margin:0 4px 0 8px;border:1px solid rgba(46,125,50,0.4)"></span>IDR region (consensus disorder ≥ threshold)
        <span style="display:inline-block;width:16px;height:6px;background:#2e7d32;margin:0 4px 0 12px"></span>Significant hotspot inside IDR window
        <span style="display:inline-block;width:16px;height:6px;background:#6e6e6e;margin:0 4px 0 12px"></span>Significant hotspot outside IDR window
        <span style="display:inline-block;width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:10px solid #c62828;margin:0 6px"></span>Curated PTM site
        <span style="display:inline-block;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:10px solid #d32f2f;margin:0 4px 0 12px"></span>Variant marker (pathogenic red, benign blue, other brown)
      </div>
      <div class="muted" style="margin-top:6px;font-size:12px">
        <strong>Definitions:</strong>
        Significant hotspots = windows passing the composition-aware permutation test with FWER q ≤ 0.10. IDR localization follows the consensus disorder threshold (≥50% disordered residues). Variant markers come from ClinVar overlap (`variant_hotspot_overlap.tsv`).
      </div>
      <div id="protein-table" style="margin-top:14px"></div>
    </section>

    <section class="panel">
      <h2>How to use this atlas</h2>
      <ol style="margin: 6px 0 0 20px;">
        <li>Use the interactive browser to visualize hotspots and their IDR context.</li>
        <li>Compare against featured case studies to benchmark regulatory archetypes.</li>
        <li>Integrate the tables listed in <code>index.json</code> into pipelines or notebooks.</li>
      </ol>
      <p style="margin-top:12px" class="muted">Need a full data dump? Clone the public repository <code>anuj2054/ptm-idr-atlas</code> or download individual tables via URLs in <code>index.json</code>.</p>
    </section>

    <div id="err" class="error" style="display:none"></div>

    <footer>
      PTM-IDR Atlas • Served via GitHub Pages • Browse index: <code>site/index.json</code>
    </footer>
  </main>

  <div id="track-tooltip" class="tooltip" style="display:none"></div>

  <script>
    (function() {
      const meta = document.getElementById('meta');
      const summaryVersion = document.getElementById('summary-version');
      const summaryGenerated = document.getElementById('summary-generated');
      const summaryArtifacts = document.getElementById('summary-artifacts');
      const err = document.getElementById('err');
      const featuredGrid = document.getElementById('featured-grid');
      const input = document.getElementById('acc-input');
      const loadBtn = document.getElementById('acc-load');
      const status = document.getElementById('protein-status');
      const infoPanel = document.getElementById('protein-info');
      const tableContainer = document.getElementById('protein-table');
      const canvas = document.getElementById('protein-canvas');
      const tooltip = document.getElementById('track-tooltip');
      const toggleIdrShading = document.getElementById('toggle-idr-shading');
      const toggleIdrHotspots = document.getElementById('toggle-idr-hotspots');
      const toggleOrderedHotspots = document.getElementById('toggle-ordered-hotspots');
      const togglePtms = document.getElementById('toggle-ptms');
      const toggleVariants = document.getElementById('toggle-variants');
      const motifList = document.getElementById('motif-list');

      const renderFlags = {
        showIdrShading: true,
        showIdrHotspots: true,
        showOrderedHotspots: true,
        showPtms: true,
        showVariants: true,
      };

      const VARIANT_COLORS = {
        pathogenic: '#d32f2f',
        benign: '#1565c0',
        other: '#795548',
        unknown: '#795548',
      };

      let currentPayload = null;
      let currentMeta = null;
      let highlightWindow = null;
      let highlightVariant = null;
      let tableRows = [];

      const classifyVariant = significance => {
        const text = String(significance || 'Unknown').toLowerCase();
        if (text.includes('pathogenic') && !text.includes('benign')) return 'pathogenic';
        if (text.includes('benign') && !text.includes('pathogenic')) return 'benign';
        if (text.includes('uncertain') || text.includes('vus')) return 'other';
        return 'unknown';
      };

      const variantColor = variant => {
        const cls = classifyVariant(variant?.significance);
        return VARIANT_COLORS[cls] || VARIANT_COLORS.unknown;
      };

      const highlightsSameVariant = (a, b) =>
        a && b && typeof a.id !== 'undefined' && typeof b.id !== 'undefined' && a.id === b.id;

      fetch('index.json', { cache: 'no-store' })
        .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
        .then(data => {
          const generated = new Date(data.generated_at);
          meta.textContent = `${data.project} • v${data.version}`;
          summaryVersion.textContent = `v${data.version}`;
          summaryGenerated.textContent = generated.toLocaleString();
          summaryArtifacts.textContent = `${(data.artifacts || []).length} datasets`;
        })
        .catch(e => {
          meta.textContent = 'PTM-IDR Atlas';
          err.style.display = 'block';
          err.textContent = 'Error loading index metadata: ' + e.message + '. You can open index.json directly using the link above.';
        });

      const FEATURED = [
        { accession: 'P00533', label: 'EGFR', subtitle: 'Epidermal growth factor receptor', blurb: 'Dense hotspot clustering in disordered tails aligns with oncogenic activation signatures (Fig. 5C).' },
        { accession: 'O75530', label: 'EED', subtitle: 'Polycomb repressive complex 2 component', blurb: 'Ultra-regulated chromatin modulator with extensive hotspot burden across IDRs.' },
        { accession: 'P37840', label: 'SNCA', subtitle: 'Alpha-synuclein', blurb: 'Neurodegenerative case study highlighting flexible-region PTM control (Figure 5B).' },
        { accession: 'P38398', label: 'BRCA1', subtitle: 'DNA damage response coordinator', blurb: 'Disordered regulatory hubs with broad hotspot coverage supporting therapeutic prioritization.' },
      ];

      featuredGrid.innerHTML = FEATURED.map(item => `
        <div class="card">
          <div class="card-title">${item.label} <span class="muted">(${item.accession})</span></div>
          <div class="muted">${item.subtitle}</div>
          <p>${item.blurb}</p>
          <canvas class="preview-canvas" data-acc="${item.accession}" width="320" height="70"></canvas>
          <button class="pill" data-acc="${item.accession}">Open in browser</button>
        </div>
      `).join('');

      if (motifList) {
        fetch('results/atlas/v1.0/motif_overlap.tsv', { cache: 'no-store' })
          .then(r => (r.ok ? r.text() : null))
          .then(text => {
            if (!text) throw new Error('motif table missing');
            const lines = text.trim().split(/\r?\n/);
            const header = lines.shift().split('\t');
            const idxName = header.indexOf('motif_name');
            const idxOR = header.indexOf('OR');
            const idxQ = header.indexOf('q_value');
            if (idxName === -1 || idxOR === -1 || idxQ === -1) throw new Error('motif columns missing');
            const rows = lines.map(line => {
              const parts = line.split('\t');
              return {
                name: parts[idxName],
                or: parseFloat(parts[idxOR] || '0'),
                q: parseFloat(parts[idxQ] || '1'),
              };
            }).filter(r => !Number.isNaN(r.q));
            rows.sort((a, b) => a.q - b.q);
            const top = rows.filter(r => r.q <= 0.1).slice(0, 5);
            motifList.innerHTML = top.length
              ? top.map(r => `<li><strong>${r.name}</strong> · OR ${r.or.toFixed(2)} · q=${r.q.toExponential(1)}</li>`).join('')
              : '<li>No motifs reached significance at q ≤ 0.1.</li>';
          })
          .catch(() => {
            motifList.innerHTML = '<li>Motif enrichment summary unavailable.</li>';
          });
      }

      function fmtWindows(wins) {
        if (!wins || wins.length === 0) {
          return '<div class="muted">No significant hotspot windows detected for this protein.</div>';
        }
        const rows = wins.slice(0, 200).map((w, idx) => `
          <tr data-index="${idx}">
            <td>${w.start}-${w.end}</td>
            <td>${w.idr ? 'IDR' : 'Ordered'}</td>
            <td>${w.ptm_count}</td>
            <td>${w.q != null ? w.q.toExponential(2) : ''}</td>
          </tr>
        `).join('');
        return `
          <table>
            <thead>
              <tr>
                <th>Window</th>
                <th>Region</th>
                <th>PTMs</th>
                <th>q-value</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      function updateInfoPanel(payload) {
        if (!payload) {
          infoPanel.innerHTML = '<strong>Select a protein</strong><div>Hotspot summary and PTM markers will appear here.</div>';
          return;
        }
        const stats = payload.stats || {};
        const length = payload.length || null;
        const idrLength = payload.idr_length ?? (
          payload.idr_segments ? payload.idr_segments.reduce((sum, seg) => sum + Math.max(0, (seg.end || seg.start) - seg.start + 1), 0) : null
        );
        const coverage = length ? `${(((idrLength || 0) / length) * 100).toFixed(1)}%` : '—';
        const windowCount = stats.window_count ?? (payload.windows ? payload.windows.length : 0);
        const idrCount = stats.idr_window_count ?? (payload.windows ? payload.windows.filter(w => w.idr).length : 0);
        const orderedCount = stats.ordered_window_count ?? (windowCount - idrCount);
        const medianPtm = stats.median_ptm_count != null ? stats.median_ptm_count : '—';
        const ptmSites = stats.ptm_site_count ?? (payload.ptm_sites ? payload.ptm_sites.length : 0);
        const variantStats = payload.variants || null;
        const variantTotal = variantStats?.total ?? 0;
        const variantHotspot = variantStats?.hotspot ?? 0;
        const variantPath = variantStats?.pathogenic_hotspot ?? 0;
        const variantBenign = variantStats?.benign_hotspot ?? 0;
        const variantLine = variantStats
          ? `Variants: ${variantTotal} total • Hotspot ${variantHotspot} (path ${variantPath}, benign ${variantBenign})`
          : 'Variants: —';

        infoPanel.innerHTML = `
          <strong>${payload.accession}</strong>
          <div>${length ? `${length.toLocaleString()} aa` : 'Length unknown'} · IDR coverage ${coverage}</div>
          <div>Hotspots: ${windowCount} (IDR ${idrCount}, Ordered ${orderedCount})</div>
          <div>Median PTMs/window: ${medianPtm} · PTM sites: ${ptmSites}</div>
          <div>${variantLine}</div>
          <div><a href="results/atlas/v1.0/proteins/${payload.accession}.json" target="_blank" rel="noopener">Download JSON</a></div>
        `;
      }

      function setRowHighlight(index) {
        tableRows.forEach(row => {
          const isActive = index != null && Number(row.dataset.index) === index;
          row.classList.toggle('row-active', isActive);
        });
      }

      function findWindowForVariant(variant) {
        if (!currentPayload || !Array.isArray(currentPayload.windows)) return null;
        return currentPayload.windows.find(
          w => variant.position >= w.start && variant.position <= w.end
        ) || null;
      }

      function renderTrack(payload, canvasEl, options = {}) {
        const ctx = canvasEl.getContext('2d');
        ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
        if (!payload) return null;

        const wins = payload.windows || [];
        const idrSegs = payload.idr_segments || [];
        const ptmSites = payload.ptm_sites || [];
        const variantStats = payload.variants || {};
        const variantList = Array.isArray(variantStats.details) ? variantStats.details : [];
        const declaredLength = payload.length || 0;

        const showIdrShading = options.showIdrShading !== false;
        const showIdrHotspots = options.showIdrHotspots !== false;
        const showOrderedHotspots = options.showOrderedHotspots !== false;
        const showPtms = options.showPtms !== false;
        const showVariants = options.showVariants !== false;
        const highlightVariantOption = options.highlightVariant || null;

        const maxExtent = Math.max(
          declaredLength,
          wins.reduce((m, w) => Math.max(m, w.end || 0), 0),
          idrSegs.reduce((m, s) => Math.max(m, s.end || 0), 0),
          ptmSites.reduce((m, s) => Math.max(m, s.position || 0), 0),
          1
        );

        const compact = Boolean(options.compact);
        const padL = compact ? 28 : 52;
        const padR = 18;
        const padT = compact ? 14 : 30;
        const trackY = padT;
        const trackH = compact ? 18 : 34;
        const innerW = Math.max(canvasEl.width - padL - padR, 20);
        const xScale = x => padL + (x / maxExtent) * innerW;

        const segments = [];
        const variantSegments = [];

        ctx.fillStyle = '#f1f3f7';
        ctx.fillRect(padL, trackY, innerW, trackH);

        if (showIdrShading && idrSegs.length) {
          ctx.fillStyle = 'rgba(46, 125, 50, 0.18)';
          idrSegs.forEach(seg => {
            const x1 = xScale(Math.max(0, (seg.start || 1) - 1));
            const x2 = xScale(Math.max(seg.start || 1, seg.end || seg.start));
            ctx.fillRect(x1, trackY, Math.max(1, x2 - x1), trackH);
          });
        }

        wins.forEach(w => {
          const drawHotspot = (w.idr && showIdrHotspots) || (!w.idr && showOrderedHotspots);
          if (!drawHotspot) return;

          const x1 = xScale(Math.max(0, w.start - 1));
          const x2 = xScale(Math.max(w.start, w.end));
          const width = Math.max(1, x2 - x1);
          const isHighlight = options.highlightWindow && options.highlightWindow === w;
          ctx.fillStyle = isHighlight ? '#1976d2' : (w.idr ? '#2e7d32' : '#6e6e6e');
          ctx.fillRect(x1, trackY + (compact ? 3 : 5), width, trackH - (compact ? 6 : 10));

          if (options.captureSegments && !compact) {
            segments.push({
              x1,
              x2,
              y1: trackY + 3,
              y2: trackY + trackH - 3,
              window: w,
            });
          }
        });

        if (options.highlightWindow && !compact) {
          const w = options.highlightWindow;
          const visible = (w.idr && showIdrHotspots) || (!w.idr && showOrderedHotspots);
          if (visible) {
            const x1 = xScale(Math.max(0, w.start - 1));
            const x2 = xScale(Math.max(w.start, w.end));
            const width = Math.max(1, x2 - x1);
            ctx.strokeStyle = '#1976d2';
            ctx.lineWidth = 2;
            ctx.strokeRect(x1, trackY + 3, width, trackH - 6);
          }
        }

        if (showPtms && ptmSites.length) {
          ctx.strokeStyle = '#c62828';
          ctx.lineWidth = compact ? 1.2 : 2;
          ptmSites.forEach(site => {
            const x = xScale(site.position || 0);
            ctx.beginPath();
            ctx.moveTo(x, trackY + trackH + 2);
            ctx.lineTo(x, trackY + trackH - (compact ? 6 : 10));
            ctx.stroke();
          });
        }

        if (showVariants && variantList.length) {
          const markerSize = compact ? 4 : 6;
          const baseY = trackY - 2;
          variantList.forEach(variant => {
            const pos = Math.max(0, (variant.position || 1) - 1);
            const x = xScale(pos);
            const yTop = baseY - markerSize - (compact ? 2 : 4);
            ctx.fillStyle = variantColor(variant);
            ctx.beginPath();
            ctx.moveTo(x, baseY);
            ctx.lineTo(x - markerSize, yTop);
            ctx.lineTo(x + markerSize, yTop);
            ctx.closePath();
            ctx.fill();
            if (highlightVariantOption && highlightsSameVariant(highlightVariantOption, variant)) {
              ctx.strokeStyle = '#111';
              ctx.lineWidth = 1.5;
              ctx.stroke();
            }
            variantSegments.push({
              x1: x - markerSize,
              x2: x + markerSize,
              y1: yTop,
              y2: baseY,
              variant,
            });
          });
        }

        ctx.strokeStyle = '#d1d6e6';
        ctx.lineWidth = 1;
        ctx.strokeRect(padL, trackY, innerW, trackH);

        ctx.fillStyle = '#454545';
        ctx.font = compact ? '10px system-ui, -apple-system, Segoe UI, Roboto, sans-serif' : '12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
        const ticks = compact ? [0, 0.5, 1] : [0, 0.25, 0.5, 0.75, 1];
        ticks.forEach(f => {
          const x = xScale(maxExtent * f);
          ctx.fillRect(x, trackY + trackH + 2, 1, compact ? 4 : 6);
          const label = Math.round(maxExtent * f);
          ctx.fillText(label.toString(), x - (compact ? 6 : 8), trackY + trackH + (compact ? 12 : 18));
        });
        if (!compact) {
          ctx.fillText('Residue position', padL, trackY - 12);
        }

        if (options.captureSegments) {
          return { segments, variantSegments, padL, padR, trackY, trackH, innerW, maxExtent };
        }
        return null;
      }

      function drawMainTrack(targetWindow, targetVariant) {
        if (!currentPayload) {
          renderTrack(null, canvas);
          currentMeta = null;
          setRowHighlight(null);
          highlightWindow = null;
          highlightVariant = null;
          return;
        }
        const windowHighlight = targetWindow || null;
        const variantHighlight = renderFlags.showVariants ? targetVariant || null : null;
        highlightWindow = windowHighlight;
        highlightVariant = variantHighlight;
        currentMeta = renderTrack(currentPayload, canvas, {
          captureSegments: true,
          highlightWindow: windowHighlight,
          highlightVariant: variantHighlight,
          showIdrShading: renderFlags.showIdrShading,
          showIdrHotspots: renderFlags.showIdrHotspots,
          showOrderedHotspots: renderFlags.showOrderedHotspots,
          showPtms: renderFlags.showPtms,
          showVariants: renderFlags.showVariants,
        });
        setRowHighlight(windowHighlight ? windowHighlight.__index : null);
      }

      function applyRenderFlags() {
        if (highlightWindow) {
          const visible = (highlightWindow.idr && renderFlags.showIdrHotspots) || (!highlightWindow.idr && renderFlags.showOrderedHotspots);
          if (!visible) {
            highlightWindow = null;
          }
        }
        if (!renderFlags.showVariants) {
          highlightVariant = null;
        }
        drawMainTrack(highlightWindow, highlightVariant);
      }

      function attachRowListeners() {
        tableRows = Array.from(tableContainer.querySelectorAll('tbody tr'));
        tableRows.forEach(row => {
          const idx = Number(row.dataset.index);
          row.addEventListener('mouseenter', () => {
            tooltip.style.display = 'none';
            if (!currentPayload || Number.isNaN(idx)) return;
            const w = currentPayload.windows[idx];
            if (!w) return;
            highlightWindow = w;
            highlightVariant = null;
            drawMainTrack(w, null);
          });
          row.addEventListener('mouseleave', () => {
            tooltip.style.display = 'none';
            highlightWindow = null;
            highlightVariant = null;
            drawMainTrack(null, null);
          });
        });
      }

      function loadProtein(acc) {
        const clean = (acc || '').trim();
        if (!clean) return;
        status.textContent = `Loading ${clean}…`;
        tableContainer.innerHTML = '';
        tooltip.style.display = 'none';
        updateInfoPanel(null);

        fetch(`results/atlas/v1.0/proteins/${encodeURIComponent(clean)}.json`, { cache: 'no-store' })
          .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
          .then(data => {
            data.windows.forEach((w, idx) => { w.__index = idx; });
            currentPayload = data;
            highlightWindow = null;
            const length = data.length || null;
            const idrLength = data.idr_length ?? (
              data.idr_segments ? data.idr_segments.reduce((sum, seg) => sum + Math.max(0, (seg.end || seg.start) - seg.start + 1), 0) : null
            );
            const coverage = length ? `${(((idrLength || 0) / length) * 100).toFixed(1)}%` : '—';
            status.textContent = `Loaded ${data.accession} • ${data.windows.length} hotspots · IDR coverage ${coverage}`;
            updateInfoPanel(data);
            tableContainer.innerHTML = fmtWindows(data.windows);
            attachRowListeners();
            if (data.windows.length > 200) {
              const note = document.createElement('div');
              note.className = 'muted';
              note.textContent = `Showing first 200 windows of ${data.windows.length}.`;
              tableContainer.appendChild(note);
            }
            if (data.ptm_sites && data.ptm_sites.length) {
              const hint = document.createElement('div');
              hint.className = 'muted';
              hint.textContent = `PTM markers: ${data.ptm_sites.length} curated sites`;
              tableContainer.appendChild(hint);
            }
            highlightVariant = null;
            drawMainTrack(null, null);
          })
          .catch(() => {
            currentPayload = null;
            highlightWindow = null;
            highlightVariant = null;
            drawMainTrack(null, null);
            status.textContent = '';
            updateInfoPanel(null);
            tableContainer.innerHTML = `<div class="error">No hotspot data for ${clean} (or accession not in this release).</div>`;
          });
      }

      function renderPreview(acc, canvasEl) {
        fetch(`results/atlas/v1.0/proteins/${encodeURIComponent(acc)}.json`, { cache: 'no-store' })
          .then(r => (r.ok ? r.json() : null))
          .then(data => { if (data) renderTrack(data, canvasEl, { compact: true, showVariants: false }); })
          .catch(() => {});
      }

      function canvasCoords(event) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
          x: (event.clientX - rect.left) * scaleX,
          y: (event.clientY - rect.top) * scaleY,
          pageX: event.clientX + window.scrollX,
          pageY: event.clientY + window.scrollY,
        };
      }

      featuredGrid.querySelectorAll('.preview-canvas').forEach(el => {
        const acc = el.getAttribute('data-acc');
        renderPreview(acc, el);
      });

      featuredGrid.querySelectorAll('button[data-acc]').forEach(btn => {
        btn.addEventListener('click', () => {
          const acc = btn.getAttribute('data-acc');
          input.value = acc;
          loadProtein(acc);
        });
      });

      loadBtn.addEventListener('click', () => loadProtein(input.value));
      input.addEventListener('keydown', e => { if (e.key === 'Enter') loadProtein(input.value); });

      toggleIdrShading.addEventListener('change', () => {
        renderFlags.showIdrShading = toggleIdrShading.checked;
        applyRenderFlags();
      });
      toggleIdrHotspots.addEventListener('change', () => {
        renderFlags.showIdrHotspots = toggleIdrHotspots.checked;
        applyRenderFlags();
      });
      toggleOrderedHotspots.addEventListener('change', () => {
        renderFlags.showOrderedHotspots = toggleOrderedHotspots.checked;
        applyRenderFlags();
      });
      togglePtms.addEventListener('change', () => {
        renderFlags.showPtms = togglePtms.checked;
        applyRenderFlags();
      });
      toggleVariants.addEventListener('change', () => {
        renderFlags.showVariants = toggleVariants.checked;
        applyRenderFlags();
      });

      canvas.addEventListener('mousemove', evt => {
        if (!currentMeta) return;
        const pos = canvasCoords(evt);

        let handled = false;
        if (renderFlags.showVariants && currentMeta.variantSegments) {
          const vSeg = currentMeta.variantSegments.find(s => pos.x >= s.x1 && pos.x <= s.x2 && pos.y >= s.y1 && pos.y <= s.y2);
          if (vSeg) {
            const variant = vSeg.variant;
            const windowMatch = variant.in_hotspot ? findWindowForVariant(variant) : null;
            drawMainTrack(windowMatch, variant);
            tooltip.style.display = 'block';
            tooltip.style.left = `${pos.pageX + 12}px`;
            tooltip.style.top = `${pos.pageY + 12}px`;
            tooltip.innerHTML = `Variant ${variant.position}${variant.in_hotspot ? ' inside hotspot' : ' outside hotspot'}<br>` +
              `Significance: ${variant.significance || 'Unknown'}`;
            handled = true;
          }
        }

        if (!handled && currentMeta.segments) {
          const seg = currentMeta.segments.find(s => pos.x >= s.x1 && pos.x <= s.x2 && pos.y >= s.y1 && pos.y <= s.y2);
          if (seg) {
            drawMainTrack(seg.window, null);
            tooltip.style.display = 'block';
            tooltip.style.left = `${pos.pageX + 12}px`;
            tooltip.style.top = `${pos.pageY + 12}px`;
            tooltip.innerHTML = `Residues ${seg.window.start}-${seg.window.end}<br>${seg.window.idr ? 'IDR hotspot' : 'Ordered hotspot'}<br>` +
              `PTMs: ${seg.window.ptm_count}${seg.window.q != null ? `<br>q = ${seg.window.q.toExponential(2)}` : ''}`;
            handled = true;
          }
        }

        if (!handled) {
          tooltip.style.display = 'none';
          if (highlightWindow || highlightVariant) {
            highlightWindow = null;
            highlightVariant = null;
            drawMainTrack(null, null);
          }
        }
      });

      canvas.addEventListener('mouseleave', () => {
        tooltip.style.display = 'none';
        highlightWindow = null;
        highlightVariant = null;
        drawMainTrack(null, null);
      });

      loadProtein('P00533');
    })();
  </script>
</body>
</html>
