<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PTM-IDR Atlas</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; color: #222; }
    header { margin-bottom: 20px; }
    h1 { margin: 0 0 6px; font-size: 22px; }
    .meta { color: #555; font-size: 14px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom: 1px solid #eee; padding: 8px 6px; text-align: left; }
    th { background: #fafafa; font-weight: 600; font-size: 14px; }
    .muted { color: #666; font-size: 12px; }
    .pill { display: inline-block; padding: 2px 6px; border-radius: 10px; background: #eef; color: #225; font-size: 12px; }
    a { color: #0b5fff; text-decoration: none; }
    a:hover { text-decoration: underline; }
    footer { margin-top: 24px; font-size: 12px; color: #666; }
    .error { color: #b00020; }
    .grid { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
  </style>
  <noscript>
    <style> #app { display:none } </style>
  </noscript>
  <meta name="robots" content="noindex">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  <meta http-equiv="pragma" content="no-cache">
  <link rel="icon" href="data:,">
  <!-- Minimal static browser for index.json -->
  <!-- If JavaScript is disabled, you can open index.json directly. -->
</head>
<body>
  <header class="grid">
    <div>
      <h1>PTM-IDR Atlas</h1>
      <div class="meta" id="meta">Loading metadata…</div>
    </div>
    <div>
      <a href="index.json" class="pill" title="View raw JSON index">index.json</a>
    </div>
  </header>

  <div id="app">
    <table id="artifacts-table" aria-label="Artifacts">
      <thead>
        <tr>
          <th>Filename</th>
          <th>Description</th>
          <th>Format</th>
          <th>Size</th>
          <th>Download</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div id="empty" class="muted" style="display:none">No artifacts found.</div>
  </div>

  <hr style="margin:24px 0; border:none; border-top:1px solid #eee">

  <section>
    <h2 style="margin:0 0 8px; font-size:18px">Protein Browser</h2>
    <div class="muted">Enter a UniProt accession to load significant hotspot windows.</div>
    <div style="margin:10px 0; display:flex; gap:8px">
      <input id="acc-input" type="text" placeholder="e.g., O14920" style="padding:6px 8px; font-size:14px; width:220px">
      <button id="acc-load" style="padding:6px 10px; font-size:14px">Load</button>
    </div>
    <div id="protein-status" class="muted"></div>
    <div id="protein-view"></div>
  </section>

  <div id="err" class="error" role="alert" style="display:none"></div>

  <footer>
    <span class="muted">Served from GitHub Pages. Uses site/index.json generated by the atlas tools.</span>
  </footer>

  <script>
    (function() {
      const meta = document.getElementById('meta');
      const tbody = document.getElementById('tbody');
      const empty = document.getElementById('empty');
      const err = document.getElementById('err');

      fetch('index.json', { cache: 'no-store' })
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.json();
        })
        .then(data => {
          meta.textContent = `${data.project} • v${data.version} • ${new Date(data.generated_at).toLocaleString()}`;

          const rows = (data.artifacts || []).map(a => {
            const tr = document.createElement('tr');

            const tdName = document.createElement('td');
            tdName.textContent = a.filename;
            tr.appendChild(tdName);

            const tdDesc = document.createElement('td');
            tdDesc.textContent = a.description || '';
            tr.appendChild(tdDesc);

            const tdFmt = document.createElement('td');
            tdFmt.textContent = (a.format || '').toUpperCase();
            tr.appendChild(tdFmt);

            const tdSize = document.createElement('td');
            const size = (typeof a.size_mb === 'number') ? `${a.size_mb.toFixed(2)} MB` : `${a.size_bytes} bytes`;
            tdSize.textContent = size;
            tr.appendChild(tdSize);

            const tdLink = document.createElement('td');
            const link = document.createElement('a');
            link.href = a.download_url;
            link.textContent = 'Download';
            link.rel = 'noopener';
            link.target = '_blank';
            tdLink.appendChild(link);
            tr.appendChild(tdLink);

            return tr;
          });

          if (rows.length === 0) {
            empty.style.display = 'block';
          } else {
            rows.forEach(tr => tbody.appendChild(tr));
          }
        })
        .catch(e => {
          meta.textContent = 'Failed to load index metadata';
          err.style.display = 'block';
          err.textContent = 'Error loading index.json: ' + e.message + '. You can open index.json directly using the link above.';
        });

      // Simple protein browser
      const input = document.getElementById('acc-input');
      const loadBtn = document.getElementById('acc-load');
      const pstat = document.getElementById('protein-status');
      const pview = document.getElementById('protein-view');

      function fmtWindows(wins) {
        if (!wins || wins.length === 0) return '<div class="muted">No significant windows found.</div>';
        const rows = wins.slice(0, 200).map(w => `
          <tr>
            <td>${w.start}-${w.end}</td>
            <td>${w.idr ? 'IDR' : 'ORD'}</td>
            <td>${w.ptm_count}</td>
            <td>${w.q != null ? w.q.toExponential(2) : ''}</td>
          </tr>
        `).join('');
        return `
          <table style="width:100%; border-collapse:collapse; margin-top:8px">
            <thead>
              <tr>
                <th style="text-align:left; border-bottom:1px solid #eee; padding:6px 4px">Window</th>
                <th style="text-align:left; border-bottom:1px solid #eee; padding:6px 4px">Region</th>
                <th style="text-align:left; border-bottom:1px solid #eee; padding:6px 4px">PTMs</th>
                <th style="text-align:left; border-bottom:1px solid #eee; padding:6px 4px">q</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        `;
      }

      function loadProtein(acc) {
        const clean = (acc || '').trim();
        if (!clean) return;
        pstat.textContent = 'Loading ' + clean + '…';
        pview.innerHTML = '';
        fetch('results/atlas/v1.0/proteins/' + encodeURIComponent(clean) + '.json', { cache: 'no-store' })
          .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
          .then(data => {
            pstat.textContent = `Loaded ${data.accession} • ${data.windows.length} windows`;
            pview.innerHTML = fmtWindows(data.windows);
          })
          .catch(e => {
            pstat.textContent = '';
            pview.innerHTML = '<div class="error">Not found or no windows for ' + clean + '</div>';
          });
      }

      loadBtn.addEventListener('click', () => loadProtein(input.value));
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') loadProtein(input.value); });
    })();
  </script>
  <noscript>
    <p class="error">JavaScript is disabled. Open <a href="index.json">index.json</a> to view artifacts.</p>
  </noscript>
</body>
<\/html>
