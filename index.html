<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PTM-IDR Atlas</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #ffffff;
      --fg: #1f1f1f;
      --muted: #616161;
      --accent: #2255cc;
      --card-bg: #f8f9ff;
      --card-border: #dee3ff;
    }
    body {
      margin: 0;
      padding: 28px 20px 40px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.5;
    }
    main { max-width: 980px; margin: 0 auto; position: relative; }
    header { margin-bottom: 28px; }
    h1 { margin: 0 0 10px; font-size: 28px; font-weight: 650; }
    h2 { font-size: 20px; margin: 0 0 10px; font-weight: 600; }
    p { margin: 0 0 12px; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .muted { color: var(--muted); font-size: 13px; }
    .hero-meta { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .summary { display: grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap: 12px; margin: 18px 0 26px; }
    .summary div { padding: 12px 14px; border: 1px solid #eceff7; border-radius: 10px; background: #fafbff; }
    .summary strong { display: block; font-size: 12px; text-transform: uppercase; letter-spacing: 0.6px; color: var(--muted); margin-bottom: 4px; }
    .summary span { font-size: 16px; font-weight: 600; }
    .pill { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 999px; border: 1px solid var(--card-border); background: #eef1ff; color: #233375; font-size: 12px; cursor: pointer; }
    .pill:hover { background: #dfe5ff; }
    .info-card { padding: 18px; border-radius: 12px; border: 1px solid #ebeffa; background: var(--card-bg); margin: 16px 0 28px; }
    .card-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap: 14px; margin-top: 14px; }
    .card { padding: 16px; border-radius: 12px; border: 1px solid var(--card-border); background: var(--card-bg); display: flex; flex-direction: column; gap: 10px; }
    .card-title { font-size: 18px; font-weight: 600; }
    .card button { align-self: flex-start; }
    .preview-canvas { width: 100%; height: 68px; border: 1px solid #e4e4e4; border-radius: 4px; margin-top: 6px; }
    .panel { margin-top: 28px; }
    .input-row { display: flex; flex-wrap: wrap; gap: 10px; margin: 12px 0; }
    input[type="text"] { padding: 8px 10px; border: 1px solid #ccd2e6; border-radius: 6px; font-size: 15px; min-width: 220px; }
    button.load-btn { padding: 8px 14px; border-radius: 6px; border: 1px solid #ccd2e6; background: #ecf1ff; font-size: 15px; cursor: pointer; }
    button.load-btn:hover { background: #dfe7ff; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { padding: 6px 6px; text-align: left; border-bottom: 1px solid #eceff5; }
    th { font-weight: 600; color: var(--muted); }
    canvas { border: 1px solid #e4e4e4; border-radius: 4px; }
    footer { margin-top: 36px; font-size: 12px; color: var(--muted); }
    .error { color: #b00020; margin-top: 12px; }
    .tooltip { position: absolute; padding: 6px 8px; border-radius: 6px; background: rgba(33, 37, 41, 0.92); color: #fff; font-size: 12px; pointer-events: none; box-shadow: 0 2px 6px rgba(0,0,0,0.18); z-index: 1000; min-width: 140px; }
    @media (max-width: 640px) {
      body { padding: 24px 16px; }
      canvas { height: 120px; }
    }
  </style>
  <meta name="robots" content="noindex">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  <meta http-equiv="pragma" content="no-cache">
  <link rel="icon" href="data:,">
</head>
<body>
  <main>
    <header>
      <h1>PTM-IDR Atlas</h1>
      <div class="hero-meta">
        <div id="meta" class="muted">Loading metadata…</div>
        <a href="index.json" class="pill" title="Programmatic catalog">index.json</a>
      </div>
      <p>The atlas delivers statistically significant PTM hotspots within intrinsically disordered regions across the human proteome. Explore curated examples, inspect any UniProt accession, or integrate the data into downstream analyses.</p>
    </header>

    <div class="summary">
      <div><strong>Version</strong><span id="summary-version">—</span></div>
      <div><strong>Generated</strong><span id="summary-generated">—</span></div>
      <div><strong>Core Tables</strong><span id="summary-artifacts">—</span></div>
    </div>

    <section class="info-card">
      <h2>What’s inside</h2>
      <ul>
        <li>Hotspot windows annotated with IDR localization and significance testing.</li>
        <li>Per-protein summaries capturing hotspot counts and regulatory burden.</li>
        <li>Validation overlays (ELM motifs, IPTMNet, variant proximity) for downstream interpretation.</li>
      </ul>
      <div class="muted">For full artifact metadata see <code>site/index.json</code>.</div>
    </section>

    <section class="panel">
      <h2>Featured case studies</h2>
      <div class="muted">Quick links to proteins highlighted in the manuscript figures and therapeutic discussion.</div>
      <div class="card-grid" id="featured-grid"></div>
    </section>

    <section class="panel">
      <h2>Interactive protein browser</h2>
      <div class="muted">Inspect significant hotspot windows for any UniProt accession.</div>
      <div class="input-row">
        <input id="acc-input" type="text" placeholder="Enter UniProt accession (e.g., P00533)">
        <button id="acc-load" class="load-btn">Load protein</button>
      </div>
      <div id="protein-status" class="muted"></div>
      <canvas id="protein-canvas" width="920" height="180" style="width:100%; height:180px; margin-top:14px"></canvas>
      <div class="muted" style="margin-top:6px">Legend: <span style="display:inline-block;width:16px;height:16px;background:rgba(46,125,50,0.18);margin:0 4px 0 8px;border:1px solid rgba(46,125,50,0.4)"></span>IDR span <span style="display:inline-block;width:16px;height:6px;background:#2e7d32;margin:0 4px 0 12px"></span>IDR hotspot <span style="display:inline-block;width:16px;height:6px;background:#6e6e6e;margin:0 4px 0 12px"></span>Ordered hotspot <span style="display:inline-block;width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:10px solid #c62828;margin:0 6px"></span>Curated PTM</div>
      <div id="protein-table" style="margin-top:14px"></div>
    </section>

    <section class="panel">
      <h2>How to use this atlas</h2>
      <ol style="margin: 6px 0 0 20px;">
        <li>Use the interactive browser to visualize hotspots and their IDR context.</li>
        <li>Compare against featured case studies to benchmark regulatory archetypes.</li>
        <li>Integrate the tables listed in <code>index.json</code> into pipelines or notebooks.</li>
      </ol>
      <p style="margin-top:12px" class="muted">Need a full data dump? Clone the public repository <code>anuj2054/ptm-idr-atlas</code> or download individual tables via URLs in <code>index.json</code>.</p>
    </section>

    <div id="err" class="error" style="display:none"></div>

    <footer>
      PTM-IDR Atlas • Served via GitHub Pages • Browse index: <code>site/index.json</code>
    </footer>
  </main>

  <div id="track-tooltip" class="tooltip" style="display:none"></div>

  <script>
    (function() {
      const meta = document.getElementById('meta');
      const summaryVersion = document.getElementById('summary-version');
      const summaryGenerated = document.getElementById('summary-generated');
      const summaryArtifacts = document.getElementById('summary-artifacts');
      const err = document.getElementById('err');
      const featuredGrid = document.getElementById('featured-grid');
      const input = document.getElementById('acc-input');
      const loadBtn = document.getElementById('acc-load');
      const status = document.getElementById('protein-status');
      const tableContainer = document.getElementById('protein-table');
      const canvas = document.getElementById('protein-canvas');
      const tooltip = document.getElementById('track-tooltip');

      let currentPayload = null;
      let currentMeta = null;
      let highlightWindow = null;

      fetch('index.json', { cache: 'no-store' })
        .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
        .then(data => {
          const generated = new Date(data.generated_at);
          meta.textContent = `${data.project} • v${data.version}`;
          summaryVersion.textContent = `v${data.version}`;
          summaryGenerated.textContent = generated.toLocaleString();
          summaryArtifacts.textContent = `${(data.artifacts || []).length} datasets`;
        })
        .catch(e => {
          meta.textContent = 'PTM-IDR Atlas';
          err.style.display = 'block';
          err.textContent = 'Error loading index metadata: ' + e.message + '. You can open index.json directly using the link above.';
        });

      const FEATURED = [
        {
          accession: 'P00533',
          label: 'EGFR',
          subtitle: 'Epidermal growth factor receptor',
          blurb: 'Dense hotspot clustering in disordered tails aligns with oncogenic activation signatures (Fig. 5C).'
        },
        {
          accession: 'O75530',
          label: 'EED',
          subtitle: 'Polycomb repressive complex 2 component',
          blurb: 'Ultra-regulated chromatin modulator with extensive hotspot burden across IDRs.'
        },
        {
          accession: 'P37840',
          label: 'SNCA',
          subtitle: 'Alpha-synuclein',
          blurb: 'Neurodegenerative case study highlighting flexible-region PTM control (Figure 5B).'
        },
        {
          accession: 'P38398',
          label: 'BRCA1',
          subtitle: 'DNA damage response coordinator',
          blurb: 'Disordered regulatory hubs with broad hotspot coverage supporting therapeutic prioritization.'
        }
      ];

      featuredGrid.innerHTML = FEATURED.map(item => `
        <div class="card">
          <div class="card-title">${item.label} <span class="muted">(${item.accession})</span></div>
          <div class="muted">${item.subtitle}</div>
          <p>${item.blurb}</p>
          <canvas class="preview-canvas" data-acc="${item.accession}" width="320" height="70"></canvas>
          <button class="pill" data-acc="${item.accession}">Open in browser</button>
        </div>
      `).join('');

      function fmtWindows(wins) {
        if (!wins || wins.length === 0) {
          return '<div class="muted">No significant hotspot windows detected for this protein.</div>';
        }
        const rows = wins.slice(0, 200).map(w => `
          <tr>
            <td>${w.start}-${w.end}</td>
            <td>${w.idr ? 'IDR' : 'Ordered'}</td>
            <td>${w.ptm_count}</td>
            <td>${w.q != null ? w.q.toExponential(2) : ''}</td>
          </tr>
        `).join('');
        return `
          <table>
            <thead>
              <tr>
                <th>Window</th>
                <th>Region</th>
                <th>PTMs</th>
                <th>q-value</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      function renderTrack(payload, canvasEl, options = {}) {
        const ctx = canvasEl.getContext('2d');
        ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
        if (!payload) return null;

        const wins = payload.windows || [];
        const idrSegs = payload.idr_segments || [];
        const ptmSites = payload.ptm_sites || [];
        const declaredLength = payload.length || 0;

        const maxExtent = Math.max(
          declaredLength,
          wins.reduce((m, w) => Math.max(m, w.end || 0), 0),
          idrSegs.reduce((m, s) => Math.max(m, s.end || 0), 0),
          ptmSites.reduce((m, s) => Math.max(m, s.position || 0), 0),
          1
        );

        const compact = Boolean(options.compact);
        const padL = compact ? 28 : 52;
        const padR = 18;
        const padT = compact ? 14 : 30;
        const trackY = padT;
        const trackH = compact ? 18 : 34;
        const innerW = Math.max(canvasEl.width - padL - padR, 20);
        const xScale = x => padL + (x / maxExtent) * innerW;

        const segments = [];

        ctx.fillStyle = '#f1f3f7';
        ctx.fillRect(padL, trackY, innerW, trackH);

        if (idrSegs.length) {
          ctx.fillStyle = 'rgba(46, 125, 50, 0.18)';
          idrSegs.forEach(seg => {
            const x1 = xScale(Math.max(0, (seg.start || 1) - 1));
            const x2 = xScale(Math.max(seg.start || 1, seg.end || seg.start));
            ctx.fillRect(x1, trackY, Math.max(1, x2 - x1), trackH);
          });
        }

        wins.forEach(w => {
          const x1 = xScale(Math.max(0, w.start - 1));
          const x2 = xScale(Math.max(w.start, w.end));
          const width = Math.max(1, x2 - x1);
          const isHighlight = options.highlightWindow && options.highlightWindow === w;
          ctx.fillStyle = isHighlight ? '#1976d2' : (w.idr ? '#2e7d32' : '#6e6e6e');
          ctx.fillRect(x1, trackY + (compact ? 3 : 5), width, trackH - (compact ? 6 : 10));
          if (options.captureSegments && !compact) {
            segments.push({
              x1,
              x2,
              y1: trackY + 3,
              y2: trackY + trackH - 3,
              window: w,
            });
          }
        });

        if (options.highlightWindow && !compact) {
          const w = options.highlightWindow;
          const x1 = xScale(Math.max(0, w.start - 1));
          const x2 = xScale(Math.max(w.start, w.end));
          const width = Math.max(1, x2 - x1);
          ctx.strokeStyle = '#1976d2';
          ctx.lineWidth = 2;
          ctx.strokeRect(x1, trackY + 3, width, trackH - 6);
        }

        if (ptmSites.length) {
          ctx.strokeStyle = '#c62828';
          ctx.lineWidth = compact ? 1.2 : 2;
          ptmSites.forEach(site => {
            const x = xScale(site.position || 0);
            ctx.beginPath();
            ctx.moveTo(x, trackY + trackH + 2);
            ctx.lineTo(x, trackY + trackH - (compact ? 6 : 10));
            ctx.stroke();
          });
        }

        ctx.strokeStyle = '#d1d6e6';
        ctx.lineWidth = 1;
        ctx.strokeRect(padL, trackY, innerW, trackH);

        ctx.fillStyle = '#454545';
        ctx.font = compact ? '10px system-ui, -apple-system, Segoe UI, Roboto, sans-serif' : '12px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
        const ticks = compact ? [0, 0.5, 1] : [0, 0.25, 0.5, 0.75, 1];
        ticks.forEach(f => {
          const x = xScale(maxExtent * f);
          ctx.fillRect(x, trackY + trackH + 2, 1, compact ? 4 : 6);
          const label = Math.round(maxExtent * f);
          ctx.fillText(label.toString(), x - (compact ? 6 : 8), trackY + trackH + (compact ? 12 : 18));
        });
        if (!compact) {
          ctx.fillText('Residue position', padL, trackY - 12);
        }

        if (options.captureSegments) {
          return { segments, padL, padR, trackY, trackH, innerW, maxExtent };
        }
        return null;
      }

      function drawMainTrack(highlightSeg) {
        if (!currentPayload) {
          renderTrack(null, canvas);
          currentMeta = null;
          return;
        }
        currentMeta = renderTrack(currentPayload, canvas, {
          captureSegments: true,
          highlightWindow: highlightSeg ? highlightSeg.window : null,
        });
      }

      function loadProtein(acc) {
        const clean = (acc || '').trim();
        if (!clean) return;
        status.textContent = `Loading ${clean}…`;
        tableContainer.innerHTML = '';
        tooltip.style.display = 'none';

        fetch(`results/atlas/v1.0/proteins/${encodeURIComponent(clean)}.json`, { cache: 'no-store' })
          .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
          .then(data => {
            currentPayload = data;
            highlightWindow = null;
            drawMainTrack(null);
            status.textContent = `Loaded ${data.accession} • ${data.windows.length} significant windows`;
            tableContainer.innerHTML = fmtWindows(data.windows);
            if (data.ptm_sites && data.ptm_sites.length) {
              const hint = document.createElement('div');
              hint.className = 'muted';
              hint.textContent = `PTM markers: ${data.ptm_sites.length} curated sites`;
              tableContainer.appendChild(hint);
            }
          })
          .catch(e => {
            currentPayload = null;
            currentMeta = null;
            drawMainTrack(null);
            status.textContent = '';
            tableContainer.innerHTML = `<div class="error">No hotspot data for ${clean} (or accession not in this release).</div>`;
          });
      }

      function canvasCoords(event) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
          x: (event.clientX - rect.left) * scaleX,
          y: (event.clientY - rect.top) * scaleY,
          pageX: event.clientX + window.scrollX,
          pageY: event.clientY + window.scrollY,
        };
      }

      canvas.addEventListener('mousemove', evt => {
        if (!currentMeta || !currentMeta.segments) return;
        const pos = canvasCoords(evt);
        const seg = currentMeta.segments.find(s => pos.x >= s.x1 && pos.x <= s.x2 && pos.y >= s.y1 && pos.y <= s.y2);
        if (seg) {
          if (highlightWindow !== seg.window) {
            highlightWindow = seg.window;
            drawMainTrack(seg);
          }
          tooltip.style.display = 'block';
          tooltip.style.left = `${pos.pageX + 12}px`;
          tooltip.style.top = `${pos.pageY + 12}px`;
          tooltip.innerHTML = `Residues ${seg.window.start}-${seg.window.end}<br>` +
            `${seg.window.idr ? 'IDR hotspot' : 'Ordered hotspot'}<br>` +
            `PTMs: ${seg.window.ptm_count}${seg.window.q != null ? `<br>q = ${seg.window.q.toExponential(2)}` : ''}`;
        } else {
          if (highlightWindow) {
            highlightWindow = null;
            drawMainTrack(null);
          }
          tooltip.style.display = 'none';
        }
      });

      canvas.addEventListener('mouseleave', () => {
        if (highlightWindow) {
          highlightWindow = null;
          drawMainTrack(null);
        }
        tooltip.style.display = 'none';
      });

      loadBtn.addEventListener('click', () => loadProtein(input.value));
      input.addEventListener('keydown', e => { if (e.key === 'Enter') loadProtein(input.value); });

      document.querySelectorAll('button[data-acc]').forEach(btn => {
        btn.addEventListener('click', () => {
          const acc = btn.getAttribute('data-acc');
          input.value = acc;
          loadProtein(acc);
        });
      });

      featuredGrid.querySelectorAll('.preview-canvas').forEach(canvasEl => {
        const acc = canvasEl.getAttribute('data-acc');
        fetch(`results/atlas/v1.0/proteins/${encodeURIComponent(acc)}.json`, { cache: 'no-store' })
          .then(r => (r.ok ? r.json() : null))
          .then(data => {
            if (data) {
              renderTrack(data, canvasEl, { compact: true });
            }
          })
          .catch(() => {});
      });

      loadProtein('P00533');
    })();
  </script>
</body>
</html>
